<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Anonymous Teacher Rating ¬∑ Zama FHE</title>

    <!-- Required for relayer/wasm workers -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />

    <!-- üîí CSP: –∑–∞–ø—Ä–µ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Å—Ç–∏–ª–µ–π (–≤ —Ç.—á. cdnjs/font-awesome) -->
    <meta http-equiv="Content-Security-Policy"
          content="
            default-src 'self';
            script-src 'self' 'unsafe-inline' https://cdn.zama.ai https://cdn.jsdelivr.net 'wasm-unsafe-eval' blob:;
            worker-src blob:;
            connect-src *;
            style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
            font-src https://fonts.gstatic.com data:;
            img-src 'self' data: blob:;
            object-src 'none';
          ">

    <!-- üßπ –†–∞–Ω–Ω–∏–π –±–ª–æ–∫–∏—Ä–∞—Ç–æ—Ä –ª—é–±—ã—Ö –∏–Ω—ä–µ–∫—Ü–∏–π font-awesome/cdnjs -->
    <script>
      (function () {
        const isFA = (n) =>
          n && n.tagName === 'LINK' &&
          /font-?awesome|cdnjs\.cloudflare\.com\/ajax\/libs\/font-awesome/i.test(n.href || '');
        const kill = (n) => { try {
          if (isFA(n)) { n.href = 'about:blank'; n.remove(); console.warn('[UI] Blocked unwanted FA link'); }
        } catch {} };
        // remove existing
        document.querySelectorAll('link[rel="stylesheet"]').forEach(kill);
        // intercept future additions
        const mo = new MutationObserver((muts) => muts.forEach(m => m.addedNodes.forEach(kill)));
        mo.observe(document.documentElement, { childList: true, subtree: true });
        // patch DOM insertion
        const ap = Node.prototype.appendChild, ib = Node.prototype.insertBefore;
        Node.prototype.appendChild = function (c) { kill(c); return ap.call(this, c); };
        Node.prototype.insertBefore = function (c, r) { kill(c); return ib.call(this, c, r); };
      })();
    </script>

    <!-- Fonts only (–±–µ–∑ –∏–∫–æ–Ω–æ–∫) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />

    <style>
      :root {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --ink: #1d2030;
        --muted: #6b7280;
        --primary: #5d5fef;
        --accent: #12b886;
        --danger: #ef4444;
        --border: #e6e8f0;
        --shadow: 0 10px 30px rgba(13, 19, 33, 0.07);
        --radius: 22px;
        --mono: "Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        --sans: "Manrope", -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, sans-serif;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin:0;
        background:
          radial-gradient(60vw 60vw at 10% -10%, #e5f8f1 0%, transparent 60%),
          radial-gradient(80vw 80vw at 100% 0%, #e7e9ff 0%, transparent 60%),
          var(--bg);
        font-family: var(--sans); color: var(--ink);
      }
      .nav { position: sticky; top: 0; z-index: 50; display:flex; align-items:center; justify-content:space-between; padding: 18px clamp(16px, 4vw, 40px); background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65)); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); }
      .brand { display:flex; gap:12px; align-items:center; }
      .logo { width:36px; height:36px; border-radius:10px; background: conic-gradient(from 180deg, #b2f5ea, #c7d2fe, #b2f5ea); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06); display:grid; place-items:center; font-weight:800; color:#2b2e4a; }
      .brand h1 { font-size: 18px; margin:0; letter-spacing: .2px; }
      .brand small { display:block; color: var(--muted); font-weight:600; margin-top:2px; }
      .connect { display:flex; align-items:center; gap:10px; padding:12px 14px; border-radius:14px; border:1px solid var(--border); background:#fff; box-shadow: var(--shadow); font-weight:700; color:#111827; cursor:pointer; transition:.2s ease; min-width:180px; justify-content:center; }
      .connect:hover { transform: translateY(-1px); }
      .pill { display:inline-flex; align-items:center; gap:8px; border-radius:999px; padding:6px 10px; font-size:12px; border:1px dashed var(--border); color: var(--muted); background:#fff; }
      .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
      .grid { display:grid; grid-template-columns: 1.1fr .9fr; gap: 28px; }
      @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
      .card { background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px clamp(18px, 3vw, 28px); }
      .card h2 { margin:0 0 12px; font-size:20px; letter-spacing:.2px; }
      .card p.lead { color: var(--muted); margin-top:0; }
      .row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
      .field { flex:1; min-width: 220px; }
      label { display:block; font-size:12px; color:var(--muted); margin-bottom:8px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; }
      input, select { width:100%; border:1px solid var(--border); border-radius:14px; padding:13px 14px; background:#fff; font: 600 14px var(--sans); color:#0f172a; outline:none; transition:.2s ease; box-shadow: inset 0 -2px 0 rgba(13,19,33,.03); }
      input:focus, select:focus { border-color: #c7d2fe; box-shadow: 0 0 0 4px rgba(93,95,239,.08); }
      .btn { appearance:none; border:0; border-radius:14px; padding:13px 16px; font-weight:800; letter-spacing:.3px; cursor:pointer; transition:.2s ease; }
      .btn-primary { background: linear-gradient(180deg, #6366f1, #4f46e5); color:#fff; }
      .btn-primary:hover { filter:brightness(1.05); transform: translateY(-1px); }
      .btn-ghost { background:#fff; border:1px solid var(--border); color:#111827; }
      .btn-ghost:hover { background:#f8fafc; }
      .btn:disabled { opacity:.55; cursor:not-allowed; }
      .meter { height: 8px; width:100%; background:#eef2ff; border-radius: 999px; overflow:hidden; }
      .meter > span { display:block; height:100%; background:linear-gradient(90deg, #34d399, #a78bfa); width:0%; transition: width .4s ease; }
      .mono { font-family: var(--mono); }
      .muted { color: var(--muted); }
      .badge { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; border:1px solid var(--border); background:#fff; font-weight:700; }
      .handles { font-size: 12px; color:#0f172a; background:#fbfbff; border:1px dashed #c7d2fe; padding:12px; border-radius:12px; word-break: break-all; }
      .avgNumber { font-size: 44px; font-weight: 800; letter-spacing: -1px; }
      .avgNumber small { font-weight:700; color:var(--muted); font-size:14px; }
      .footer { margin: 40px auto 80px; text-align:center; color:var(--muted); }
      .ok { color: #059669; }
      .err { color: #ef4444; }
      .warn { color:#b45309; }
    </style>
  </head>
  <body>
    <header class="nav">
      <div class="brand">
        <div class="logo">üõ°Ô∏è</div>
        <div>
          <h1>Anonymous Teacher Rating</h1>
          <small>Fully Homomorphic ¬∑ Sepolia</small>
        </div>
      </div>
      <button id="btnConnect" class="connect"><span style="font-weight:900">Œû</span><span>Connect Wallet</span></button>
    </header>

    <main class="container">
      <section class="grid">
        <!-- Submit rating -->
        <article class="card">
          <h2>Submit a Private Rating</h2>
          <p class="lead">Pick a teacher, choose a score, and submit. Your rating stays encrypted; only totals are public.</p>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Teacher ID</label>
              <div class="row">
                <input id="teacherId" type="number" min="1" placeholder="e.g. 1" />
                <button id="btnFetchTeacher" class="btn btn-ghost" title="Load teacher name">üîé</button>
              </div>
              <div id="teacherName" class="muted" style="margin-top:6px">&nbsp;</div>
            </div>
            <div class="field">
              <label>Score <span id="rangeLabel" class="muted"></span></label>
              <div class="row">
                <input id="rating" type="range" min="1" max="10" step="1" value="5" style="flex:1"/>
                <input id="ratingVal" type="number" min="1" max="10" value="5" style="width:90px;"/>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <button id="btnSubmit" class="btn btn-primary">üîí Submit Encrypted Rating</button>
            <span id="txStatus" class="pill mono">Idle</span>
          </div>

          <div style="margin-top:18px" class="muted">Contract: <span class="mono" id="addr"></span></div>
        </article>

        <!-- Public average -->
        <article class="card">
          <h2>Public Average</h2>
          <p class="lead">Anyone can decrypt the encrypted sum & count via the Relayer and compute the average off-chain.</p>

          <div class="row">
            <div class="field">
              <label>Teacher ID</label>
              <input id="teacherIdAgg" type="number" min="1" placeholder="e.g. 1" />
            </div>
            <div class="field" style="align-self:flex-end">
              <button id="btnRefresh" class="btn btn-ghost">üîÑ Refresh</button>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="badge"><span style="color:#34d399">‚óâ</span><span>Sum & Count Handles</span></div>
          </div>
          <div class="handles mono" id="handles">‚Äî</div>

          <div style="margin-top:14px" class="row">
            <div class="field">
              <div class="meter"><span id="meter"></span></div>
            </div>
            <div style="text-align:right; min-width:140px">
              <div class="avgNumber" id="avg">‚Äì</div>
              <small>Average score</small>
            </div>
          </div>
        </article>
      </section>

      <!-- Owner tools -->
      <section class="card" style="margin-top:28px">
        <h2>Owner Tools</h2>
        <p class="lead">Add new teachers or re-mark aggregates as publicly decryptable.</p>
        <div id="ownerInfo" class="muted" style="margin-bottom:10px">Owner: ‚Äî</div>
        <div class="row">
          <div class="field"><label>New Teacher ID</label><input id="newId" type="number" min="1" placeholder="e.g. 7"></div>
          <div class="field"><label>Display Name</label><input id="newName" type="text" placeholder="e.g. Prof. Ada"></div>
          <button id="btnAddTeacher" class="btn btn-ghost">üë§‚ûï Add Teacher</button>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="field"><label>Ensure Public for Teacher ID</label><input id="pubId" type="number" min="1" placeholder="e.g. 1"></div>
          <button id="btnEnsurePublic" class="btn btn-ghost">üì£ Ensure Public</button>
        </div>
        <div id="ownerHint" class="muted" style="margin-top:8px"></div>
      </section>

      <p class="footer">Powered by <b>Zama FHE</b> ¬∑ Relayer SDK 0.2.0 ¬∑ Ethers v6</p>
    </main>

    <!-- SDKs -->
    <script type="module" crossorigin src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"></script>
    <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm"></script>

    <script type="module">
      import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";
      import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js";

      const CONTRACT_ADDRESS = "0xDF3920F9500C29F6e8e1441f53A6d572c134Fce2";
      const RELAYER_URL = "https://relayer.testnet.zama.cloud";

      const abi = [
        { inputs: [], name: "version", outputs: [{ type: "string" }], stateMutability: "pure", type: "function" },
        { inputs: [{ name: "teacherId", type: "uint256" }, { name: "ratingExt", type: "bytes32" }, { name: "proof", type: "bytes" }], name: "submitRating", outputs: [], stateMutability: "nonpayable", type: "function" },
        { inputs: [{ name: "teacherId", type: "uint256" }], name: "getAggregateHandles", outputs: [{ name: "sumH", type: "bytes32" }, { name: "countH", type: "bytes32" }], stateMutability: "view", type: "function" },
        { inputs: [{ name: "teacherId", type: "uint256" }], name: "teacherName", outputs: [{ type: "string" }], stateMutability: "view", type: "function" },
        { inputs: [{ name: "teacherId", type: "uint256" }], name: "teacherExists", outputs: [{ type: "bool" }], stateMutability: "view", type: "function" },
        { inputs: [{ name: "teacherId", type: "uint256" }], name: "ensurePublic", outputs: [], stateMutability: "nonpayable", type: "function" },
        { inputs: [{ name: "teacherId", type: "uint256" }, { name: "name", type: "string" }], name: "addTeacher", outputs: [], stateMutability: "nonpayable", type: "function" },
        { inputs: [], name: "owner", outputs: [{ type: "address" }], stateMutability: "view", type: "function" },
        { inputs: [], name: "minRating", outputs: [{ type: "uint8" }], stateMutability: "view", type: "function" },
        { inputs: [], name: "maxRating", outputs: [{ type: "uint8" }], stateMutability: "view", type: "function" },
      ];

      // ====== Elements ======
      const $ = (id) => document.getElementById(id);
      const els = {
        btnConnect: $("btnConnect"),
        addr: $("addr"),
        txStatus: $("txStatus"),
        teacherId: $("teacherId"),
        btnFetchTeacher: $("btnFetchTeacher"),
        teacherName: $("teacherName"),
        rating: $("rating"),
        ratingVal: $("ratingVal"),
        rangeLabel: $("rangeLabel"),
        btnSubmit: $("btnSubmit"),
        teacherIdAgg: $("teacherIdAgg"),
        btnRefresh: $("btnRefresh"),
        handles: $("handles"),
        avg: $("avg"),
        meter: $("meter"),
        ownerInfo: $("ownerInfo"),
        ownerHint: $("ownerHint"),
        newId: $("newId"), newName: $("newName"), btnAddTeacher: $("btnAddTeacher"),
        pubId: $("pubId"), btnEnsurePublic: $("btnEnsurePublic"),
      };

      // ====== State & helpers ======
      let provider, signer, user, contract, relayer;

      async function nextNonce(){
        try { return await (signer?.getNonce?.("pending") ?? provider.getTransactionCount(user, "pending")); }
        catch { return undefined; }
      }

      const DEBUG = true;
      const stamp = () => new Date().toISOString();
      function dlog(...args){ if (DEBUG) console.log(`%c[FHE-UI ${stamp()}]`, 'color:#6b7280', ...args); }

      // ====== Verbose crypto logging helpers ======
      function kb(n){ return (n/1024).toFixed(2)+' KB'; }
      function ms(start){ return (performance.now()-start).toFixed(1)+'ms'; }
      function preview(s, n=12){ s=String(s); return s.length>2*n ? s.slice(0,n)+'‚Ä¶'+s.slice(-n) : s; }
      function asBigint(x){ try{ return BigInt(x); }catch{ return undefined; } }

      const FHELOG = {
        encStart(meta){ console.groupCollapsed('%c[FHE] encrypt ‚Üí createInput','color:#2563eb', meta); },
        encAdd(tag, val){ console.log('%c[FHE]   add','color:#2563eb', tag, val); },
        encDone(hs, proofBytes, dtMs){
          const first = hs?.[0];
          console.log('%c[FHE] encrypt() done','color:#2563eb',
            { handles: hs, firstHandle: first ? preview(first) : '(none)', proofBytes, size: kb(proofBytes), time: dtMs });
          console.groupEnd();
        },
        submit(txhash){ console.log('%c[FHE] tx','color:#6b7280', txhash); },

        decPublicStart(handles){ console.groupCollapsed('%c[FHE] decrypt(public)','color:#059669', handles); },
        decPublicDone(out, dtMs){ console.log('%c[FHE] publicDecrypt OK','color:#059669', { out, time: dtMs }); console.groupEnd(); },

        decUserStart(meta){ console.groupCollapsed('%c[FHE] decrypt(user)','color:#10b981', meta); },
        decUserSig(sig){ console.log('%c[FHE]   EIP-712 sig','color:#10b981', { len: sig.length, preview: preview(sig) }); },
        decUserDone(out, dtMs){ console.log('%c[FHE] userDecrypt OK','color:#10b981', { out, time: dtMs }); console.groupEnd(); },

        average(sum,count,avg){
          console.log('%c[FHE] average','color:#334155', { sum: String(sum), count: String(count), avg });
        }
      };

      function formatAddr(a){ return a ? a.slice(0,6) + "‚Ä¶" + a.slice(-4) : "‚Äî"; }
      function setBusy(el, busy){ busy ? el.setAttribute("disabled", "") : el.removeAttribute("disabled"); }
      function setStatus(txt, ok=true, warn=false){ els.txStatus.textContent = txt; els.txStatus.className = `pill mono ${ok? (warn? 'warn' : 'ok') : 'err'}`; }
      function syncRange(){ els.ratingVal.value = els.rating.value; }
      function syncNumber(){ els.rating.value = els.ratingVal.value; }

      $("addr") && ( $("addr").textContent = CONTRACT_ADDRESS );
      els.teacherIdAgg.value = 1;
      syncRange();
      els.rating.addEventListener("input", syncRange);
      els.ratingVal.addEventListener("input", syncNumber);

      // ====== Wire up ======
      els.btnConnect.addEventListener("click", connect);
      els.btnFetchTeacher.addEventListener("click", fetchTeacher);
      els.btnSubmit.addEventListener("click", submitRating);
      els.btnRefresh.addEventListener("click", refreshAgg);
      els.btnAddTeacher.addEventListener("click", addTeacher);
      els.btnEnsurePublic.addEventListener("click", ensurePublic);

      function parseRevert(err){
        const s = err?.shortMessage || err?.reason || err?.message || String(err);
        if (s.includes('Teacher not found')) return 'Teacher not found';
        if (s.includes('Not owner') || s.includes('not owner')) return 'Only owner can perform this action';
        if (s.includes('execution reverted')) return 'Execution reverted (check inputs and permissions)';
        return s;
      }

      // ====== Connect ======
      async function connect(){
        try{
          setBusy(els.btnConnect, true);
          if(!window.ethereum) throw new Error("MetaMask not found");
          provider = new BrowserProvider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          const net = await provider.getNetwork();
          dlog('network', net.chainId.toString());
          if(net.chainId !== 11155111n){ await provider.send("wallet_switchEthereumChain", [{ chainId: "0xaa36a7" }]); }
          signer = await provider.getSigner();
          user = await signer.getAddress();
          contract = new Contract(CONTRACT_ADDRESS, abi, signer);

          await initSDK();
          relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, network: window.ethereum });
          console.log('%c[FHE] relayer ready','color:#0ea5e9', { url: RELAYER_URL, network: 'Sepolia' });

          els.btnConnect.innerHTML = `<span style="color:#10b981">‚úÖ</span> ${formatAddr(user)}`;
          els.ownerInfo.textContent = `Owner: ‚Ä¶`;

          // Bounds (fallback 1..10)
          let min=1, max=10; try { min = Number(await contract.minRating()); } catch{}; try { max = Number(await contract.maxRating()); } catch{};
          els.rating.min = String(min); els.rating.max = String(max);
          els.ratingVal.min = String(min); els.ratingVal.max = String(max);
          els.rangeLabel.textContent = `(${min}..${max})`;

          // Owner section
          try {
            const owner = await contract.owner();
            const isOwner = owner.toLowerCase()===user.toLowerCase();
            els.ownerInfo.textContent = `Owner: ${formatAddr(owner)} ${isOwner?'(you)':''}`;
            els.btnAddTeacher.disabled=!isOwner; els.btnEnsurePublic.disabled=!isOwner;
            els.ownerHint.textContent = isOwner? 'You can add teachers or re-publish aggregates.' : 'Connect the owner wallet to manage.';
          } catch {}

          setStatus("Connected", true);
        } catch(e){ console.error(e); setStatus(parseRevert(e), false); }
        finally { setBusy(els.btnConnect, false); }
      }

      // ====== Read teacher ======
      async function fetchTeacher(){
        try{
          const id = BigInt(els.teacherId.value || 0);
          if(id<=0n) throw new Error("Enter a valid teacher id");
          const exists = await contract.teacherExists(id);
          if(!exists){ els.teacherName.innerHTML = `<span class='err'>No such teacher</span>`; return; }
          const name = await contract.teacherName(id);
          els.teacherName.textContent = name && name.length? name : "(no name set)";
        } catch(e){ els.teacherName.innerHTML = `<span class='err'>${parseRevert(e)}</span>`; }
      }

      // ====== Submit encrypted rating ======
      async function submitRating(){
        try{
          setBusy(els.btnSubmit, true);
          const id = BigInt(els.teacherId.value || 0);
          if(id<=0n) throw new Error("Enter a valid teacher id");
          const exists = await contract.teacherExists(id);
          if(!exists){ setStatus('Teacher not found', false); return; }

          const score = Number(els.rating.value);
          if(Number.isNaN(score) || score<Number(els.rating.min) || score>Number(els.rating.max)){
            throw new Error("Score out of bounds");
          }

          dlog("submitRating:start", { teacherId: id.toString(), score });

          setStatus("Encrypting‚Ä¶", true);
          const t0 = performance.now();
          FHELOG.encStart({ contract: CONTRACT_ADDRESS, teacherId: id.toString() });

          const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
          FHELOG.encAdd('add8(score)', score);
          buf.add8(score);

          const { handles, inputProof } = await buf.encrypt();
          FHELOG.encDone(handles, inputProof?.length ?? 0, ms(t0));

          const h = handles[0];
          dlog("encrypt:firstHandle", h);

          setStatus("Submitting‚Ä¶", true);
          await contract.submitRating.staticCall(id, h, inputProof);
          dlog("staticCall:ok");
          const tx = await contract.submitRating(id, h, inputProof, { nonce: await nextNonce() });
          FHELOG.submit(tx.hash);
          const rcpt = await tx.wait();
          dlog("tx:mined", { blockNumber: rcpt.blockNumber, gasUsed: rcpt.gasUsed?.toString?.() });
          setStatus("Rating submitted ‚úî", true);
        } catch(e){ setStatus(parseRevert(e), false); }
        finally { setBusy(els.btnSubmit, false); }
      }

      // ====== Read aggregates, decrypt, display average ======
      async function refreshAgg(){
        try{
          setBusy(els.btnRefresh, true);
          const id = BigInt(els.teacherIdAgg.value || 0);
          if(id<=0n) throw new Error("Enter a valid teacher id");
          const exists = await contract.teacherExists(id);
          if(!exists){ els.handles.textContent = 'No such teacher'; return; }

          const [sumH, countH] = await contract.getAggregateHandles(id);
          els.handles.textContent = `sum: ${sumH}\ncount: ${countH}`;
          dlog("agg:handles", { sumH, countH });

          let sum=0n, count=0n;
          try{
            // ‚Äî Public decrypt ‚Äî
            FHELOG.decPublicStart([sumH, countH]);
            const tPub = performance.now();
            const out = await relayer.publicDecrypt([sumH, countH]);
            FHELOG.decPublicDone(out, ms(tPub));

            if(Array.isArray(out)){
              sum = asBigint(out[0]) ?? 0n; 
              count = asBigint(out[1]) ?? 0n;
            } else {
              sum = asBigint(out[sumH]) ?? 0n; 
              count = asBigint(out[countH]) ?? 0n;
            }
          } catch(e){
            // ‚Äî User decrypt fallback ‚Äî
            dlog("publicDecrypt:failed -> userDecrypt", e?.message || e);
            const kp = await generateKeypair();
            const startTs = Math.floor(Date.now()/1000).toString();
            const days = "7";
            const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);

            FHELOG.decUserStart({ handles: [sumH, countH], startTs, days, addr: await provider.getSigner().then(s=>s.getAddress()) });

            const sig = await (await provider.getSigner()).signTypedData(
              eip.domain,
              { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
              eip.message
            );
            FHELOG.decUserSig(sig);

            const pairs = [
              { handle: sumH, contractAddress: CONTRACT_ADDRESS },
              { handle: countH, contractAddress: CONTRACT_ADDRESS }
            ];

            const tUsr = performance.now();
            const dec = await relayer.userDecrypt(
              pairs,
              kp.privateKey,
              kp.publicKey,
              sig.replace("0x",""),
              [CONTRACT_ADDRESS],
              (await provider.getSigner()).address,
              startTs,
              days
            );
            FHELOG.decUserDone(Object.keys(dec), ms(tUsr));

            sum = asBigint(dec[sumH] ?? dec[Object.keys(dec).find(k=>k.toLowerCase()===String(sumH).toLowerCase())]) ?? 0n;
            count = asBigint(dec[countH] ?? dec[Object.keys(dec).find(k=>k.toLowerCase()===String(countH).toLowerCase())]) ?? 0n;
          }

          // ‚Äî Average & UI ‚Äî
          const avg = (count>0n) ? Number(sum)/Number(count) : 0;
          const pct = Math.min(100, (avg - Number(els.rating.min)) / (Number(els.rating.max)-Number(els.rating.min)) * 100);
          els.meter.style.width = isFinite(pct)? `${pct}%` : '0%';
          els.avg.innerHTML = `${avg.toFixed(2)} <small>/ ${els.rating.max}</small>`;
          FHELOG.average(sum, count, avg);
        } catch(e){
          els.handles.textContent = `Error: ${parseRevert(e)}`;
          els.avg.textContent = '‚Äì';
          els.meter.style.width = '0%';
        } finally { setBusy(els.btnRefresh, false); }
      }

      // ====== Owner: add teacher ======
      async function addTeacher(){
        try{
          setBusy(els.btnAddTeacher, true);
          const id = BigInt(els.newId.value || 0);
          const name = els.newName.value.trim();
          if(id<=0n) throw new Error("Provide an id");
          const owner = await contract.owner();
          if(owner.toLowerCase() !== (await signer.getAddress()).toLowerCase()){
            throw new Error('Only owner can perform this action');
          }
          try { const exists = await contract.teacherExists(id); if(exists) throw new Error('Teacher already exists'); } catch {}
          await contract.addTeacher.staticCall(id, name);
          const tx = await contract.addTeacher(id, name, { nonce: await nextNonce() });
          await tx.wait();
          els.ownerHint.textContent = `Added teacher ${id} (${name||"no name"})`;
        } catch(e){ els.ownerHint.textContent = `Error: ${parseRevert(e)}`; }
        finally { setBusy(els.btnAddTeacher, false); }
      }

      // ====== Owner: ensure public ======
      async function ensurePublic(){
        try{
          setBusy(els.btnEnsurePublic, true);
          const id = BigInt(els.pubId.value || 0);
          if(id<=0n) throw new Error("Provide an id");
          const owner = await contract.owner();
          if(owner.toLowerCase() !== (await signer.getAddress()).toLowerCase()){
            throw new Error('Only owner can perform this action');
          }
          const exists = await contract.teacherExists(id);
          if(!exists) throw new Error('Teacher not found');
          await contract.ensurePublic.staticCall(id);
          const tx = await contract.ensurePublic(id, { nonce: await nextNonce() });
          await tx.wait();
          els.ownerHint.textContent = `Re-marked aggregates as public for #${id}`;
        } catch(e){ els.ownerHint.textContent = `Error: ${parseRevert(e)}`; }
        finally { setBusy(els.btnEnsurePublic, false); }
      }
    </script>
  </body>
</html>
